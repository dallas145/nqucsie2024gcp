# ç¬¬åä¸‰é€±

## Cloud Run Function

### Function-1 (Hello world)
* Create function
    - Basics
        - Environment: `Cloud Run function (1st gen)`
        - Function name: `function-1`
        - Region: `asia-east1 (Taiwan)`
    - Trigger
        - Trigger type: `HTTP`
        - Authentication: `Allow unauthentication invocations`
        - Require HTTPS
    - Save
    - Next
* Code
    - Runtime: `Python 3.12`

ç›´æ¥æŒ‰`DEPLOY`ï¼Œæ¸¬è©¦ç¯„ä¾‹ç¨‹å¼ã€‚<br>
æˆåŠŸéƒ¨ç½²å¾Œï¼Œé»æ“Š`TESTING`é€²å…¥æ¸¬è©¦é é¢ï¼Œé»æ“Š`RUN IN CLOUD SHELL`ï¼Œåœ¨Cloud Shellå‡ºç¾å¾Œï¼ŒæŒ‰EnteråŸ·è¡ŒæŒ‡ä»¤ã€‚
![](src/linux-2024120301.png)

### Function-2 (Machine Learning Model as a Serverless Endpoint using Google Cloud Functions)
åƒè€ƒè³‡æ–™ï¼š[Machine Learning Model as a Serverless Endpoint using Google Cloud Functions](https://towardsdatascience.com/machine-learning-model-as-a-serverless-endpoint-using-google-cloud-function-a5ad1080a59e) Member-Only, I can't read it. (SadğŸ˜¢<br>
ä½¿ç”¨ç¨‹å¼ï¼š[GitHub - saedhussain/gcp_serverless_ml: Productionization of machine learning models as serverless solutions on GCP](https://github.com/saedhussain/gcp_serverless_ml)

1. é–‹å•ŸCloud Shellï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å»ºç«‹è³‡æ–™å¤¾ï¼Œä¸¦åœ¨å…¶ä¸­cloneæ‰€éœ€ç¨‹å¼ç¢¼ã€‚
```bash
mkdir test_iris
cd test_iris
git clone https://github.com/saedhussain/gcp_serverless_ml.git
```
2. é€²å…¥`gcp_serverless_ml`ï¼Œé€²å…¥`Iris_model`ï¼Œç·¨è¼¯`create_iris_model.py`ï¼Œå°‡ç¬¬34è¡Œæ”¹ç‚º`pickle.dump(model, open("iris_model.pkl", "wb"))`
```bash
cd gcp_serverless_ml/Iris_model
vim create_iris_model.py
# 34Gci"iris_model.pkl<c-[>:wq
```
3. å®‰è£å¿…è¦å¥—ä»¶
```bash
pip install numpy pandas scikit-learn
```
4. åŸ·è¡Œ`create_iris_model.py`
```bash
python create_iris_model.py
```
5. ä¸‹è¼‰ç”¢ç”Ÿçš„`iris_model.pkl`æª”æ¡ˆï¼Œé»æ“ŠCloud Shellçš„`More -> Download`ï¼Œè¼¸å…¥æª”æ¡ˆçš„çµ•å°è·¯å¾‘ï¼Œå¦‚`/home/mikelg512/test_iris/gcp_serverless_ml/Iris_model/iris_model.pkl`
6. åˆ°Cloud Storageå»ºç«‹ä¸€å€‹Bucketï¼Œå°‡`iris_model.pkl`ä¸Šå‚³ã€‚
    - Name: `my-iris-pkl`
    - Region: Single Region: `asia-east1 (Taiwan)`
    - `CREATE`

    å»ºç«‹å®Œæˆå¾Œï¼Œé»æ“Š`UPLOAD`ï¼Œä¸Šå‚³æª”æ¡ˆã€‚
7. å›åˆ°Cloud Run Functionå»ºç«‹æ–°çš„Function
* Create function
    - Basics
        - Environment: `Cloud Run function (1st gen)`
        - Function name: `function-1`
        - Region: `asia-east1 (Taiwan)`
    - Trigger
        - Trigger type: `HTTP`
        - Authentication: `Allow unauthentication invocations`
        - Require HTTPS
    - Save
    - Next
* Code
    - Runtime: `Python 3.12`<br>
    åˆ°[main.py](https://github.com/saedhussain/gcp_serverless_ml/blob/main/Iris_http_cloud_func/main.py)è¤‡è£½ç¨‹å¼ç¢¼ä¸¦è²¼ä¸Šåˆ°`main.py`ã€‚<br>
    é‚„æœ‰è¤‡è£½[requirements.txt](https://github.com/saedhussain/gcp_serverless_ml/blob/main/Iris_http_cloud_func/requirements.txt)è²¼ä¸Šåˆ°`requierments.txt`<br>
    è¤‡è£½å®Œæˆå¾Œï¼Œæ›´æ”¹ç¬¬18ã€19ã€20è¡Œï¼š<br>
        ```python
        BUCKET_NAME        = "my-iris-pkl"
        PROJECT_ID         = "ä½ çš„project ID"
        GCS_MODEL_FILE     = "iris_model.pkl"
        ```
        é‚„æœ‰å°‡`Entry point`æ”¹æˆ`iris_predict`<br>
* é»æ“ŠDEPLOY
8. æ¸¬è©¦
* é»æ“ŠTESTINGé€²è¡Œæ¸¬è©¦ï¼Œä¿®æ”¹å·¦é‚Šçš„Configure Triggering Eventï¼š
    ```
    {
        "features": [2,4,3,4]
    }
    ```

* é»æ“Šå³é‚Šçš„CLI test commandå³é‚Šçš„RUN IN CLOUD SHELLï¼ŒæŒ‰ä¸‹Enter

> * \[2,4,3,4]: Iris-Virginica
> * \[3,2,4,1]: Iris-Versicolor
> * \[4,3,2,1]: Iris-Setosa

![](src/linux-2024120302.png)

### è‡ªå‹•åµæ¸¬ä¸Šå‚³åˆ°Cloud Storage Bucketçš„æª”æ¡ˆå¤§å°ä¸¦ç§»å‹•Bucket
åƒè€ƒè³‡æ–™ï¼š[Move Large Files from GCS bucket using Cloud Function](https://medium.com/google-cloud/move-large-files-from-gcs-bucket-using-cloud-function-232852b10a4c)
1. å»ºç«‹å…©å€‹Bucket
- Name: `mikelg-bkt-ori` <sup>Global unique required</sup>
    - Region: `asia-east1 (Taiwan)`
    - CREATE
- Name: `mikelg-bkt-large`
    - Region: `asia-east1 (Taiwan)`
    - CREATE
2. å»ºç«‹Cloud functionï¼š
* Create function
    - Basics
        - Environment: `Cloud Run function (1st gen)`
        - Function name: `move-files`
        - Region: `asia-east1 (Taiwan)`
    - Trigger
        - Trigger type: `Cloud Storage`
        - Event type: `On (finalizing/creating) file in the selected bucket`
        - Bucket: `mikelg-bkt-ori`
    - Next
* Code
    - Runtime: `python 3.12`
    - requirement.txt:
        ```
        functions-framework==3.*
        google-cloud-storage
        google-cloud
        ```
    - main.py:<br>
        ```python
        import functions_framework
        from google.cloud import storage
        from google.cloud.storage import Blob

        # Triggered by a change in a storage bucket
        @functions_framework.cloud_event
        def hello_gcs(cloud_event):

            data = cloud_event.data

            event_id = cloud_event["id"]
            event_type = cloud_event["type"]

            bucket = data["bucket"]
            name = data["name"]
            metageneration = data["metageneration"]
            timeCreated = data["timeCreated"]
            updated = data["updated"]
            
            print("="*30)
            print(f"Event ID: {event_id}")
            print(f"Event type: {event_type}")
            print(f"Bucket: {bucket}")
            print(f"File: {name}")
            print(f"Metageneration: {metageneration}")
            print(f"Created: {timeCreated}")
            print(f"Updated: {updated}")
            print(f"Processing file: {name}.")
            storage_client = storage.Client(project='rare-sound-436602-v7') # è‡ªå·±çš„project ID
            source_bucket=storage_client.get_bucket('mikelg-bkt-ori')       # è‡ªå·±çš„bkt-ori
            destination_bucket=storage_client.get_bucket('mikelg-bkt-large')# è‡ªå·±çš„bkt-large 
            blobs=list(source_bucket.list_blobs(prefix=''))
            print(blobs)
            for blob in blobs:
                if blob.size > 1000000 and blob.name == name:
                    source_blob = source_bucket.blob(blob.name)
                    new_blob = source_bucket.copy_blob(source_blob, destination_bucket, blob.name) 
                    blob.delete(if_generation_match=None)
                    print(f'File moved from {source_blob} to {new_blob}')
                else:
                    print("File size is below 1MB")
        ```

        * è¨˜å¾—æ”¹30åˆ°32è¡Œ

    * DEPLOY

3. æ¸¬è©¦
* ä¸Šå‚³`iris_model.pkl`åˆ°bkt-ori
    ![](src/linux-2024120303.png)
