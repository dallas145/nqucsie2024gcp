# 第十五週

## Cloud Run

### docker:apache2
1. 建立`~/test-docker`資料夾
```bash
mkdir ~/test-docker
cd ~/test-docker
```

2. 建立`Dockerfile`檔案（D要大寫）
```Dockerfile
FROM ubuntu/apache2:latest
ADD index.html /var/www/html
```

3. 建立`index.html`
```html
hi test
```

4. 建立鏡像
```bash
sudo docker build -t mywww:1.0 .
```

5. 執行鏡像
```bash
sudo docker run -d -p 8080:80 mywww:1.0
```
6. 測試是否建立成功<br>
點擊Cloud Shell上的`Web Preview`按鈕，選擇`8080` port，成功的話會看到`hi test`

![](src/linux-2024121701.png)

## 建立 Artifact Registry
- Name: `mydocker`
- Format: `Docker`
- Mode: `Standard`
- Location type: `Region`
- Region: `asia-east1 (Taiwan)`
- `CREATE`

### 將 docker image build 到 Registry
**docker image name 格式：`Registry/Repository/Name`**<br>
Registry 格式：`{Region}-docker.pkg.dev/{Porject ID}`

使用剛建立的 Registry/Repo ：`asia-east1-docker.pkg.dev/rare-sound-436602-v7/mydocker`

重新 build 剛剛的 Dockerfile<br>
```bash
docker build -t asia-east1-docker.pkg.dev/rare-sound-436602-v7/mydocker/mywww:1.0 .
```

將剛 build 好的 image push 上去<br>
```bash
docker push asia-east1-docker.pkg.dev/rare-sound-436602-v7/mydocker/mywww:1.0
```

push 完成後，點進 image 頁面，點擊 `Deploy to Cloud Run`<br>
![](src/linux-2024121702.png)

- Configure
    - Region: `asia-east1 (Taiwan)`
    - Authenticaton: `Allow unauthenticated invocations`
- Container(s), Volumes, Networking, Security:
    - Container port: `80`
- CREATE

點擊 app URL 查看是否成功<br>
![](src/linux-2024121703.png)

**做完就可以刪掉了。**

### iris
1. 建立 `main.py`, `requirements.txt`, `Dockerfile`, `client.py`, `train_model.py`

```python
# main.py

import pickle

from flask import Flask, request, jsonify

app = Flask(__name__)

# Load the model
model = pickle.load(open('model.pkl', 'rb'))
labels = {
  0: "versicolor",
  1: "setosa",
  2: "virginica"
}

@app.route("/", methods=["GET"])
def index():
    """Basic HTML response."""
    body = (
        "<html>"
        "<body style='padding: 10px;'>"
        "<h1>Welcome to my Flask API</h1>"
        "</body>"
        "</html>"
    )
    return body

@app.route('/api', methods=['POST'])
def predict():
    # Get the data from the POST request.
    data = request.get_json(force = True)
    predict = model.predict(data['feature'])
    return jsonify(predict[0].tolist())

if __name__ == '__main__':
    app.run(debug = True, host = '0.0.0.0', port=8080)
```

`requirement.txt`:
```txt
scikit-learn
flask
```

`Dockerfile`
```docker
FROM python:3.9
 
WORKDIR /app
 
ADD . /app
 
RUN pip install -r requirements.txt
 
CMD ["python", "main.py"]

EXPOSE 8080
```

```python
# client.py

# -*- coding: utf-8 -*-
import requests
# Change the value of experience that you want to test
url = 'http://127.0.0.1:8080/api'
feature = [[5.8, 4.0, 1.2, 0.2]]
labels ={
  0: "setosa",
  1: "versicolor",
  2: "virginica"
}

r = requests.post(url,json={'feature': feature})
print(labels[r.json()])
```

```python
# train_model.py

# -*- coding: utf-8 -*-
import pickle
from sklearn import datasets
from sklearn.model_selection import train_test_split
from sklearn import tree

# simple demo for traing and saving model
iris=datasets.load_iris()
x=iris.data
y=iris.target

#labels for iris dataset
labels ={
  0: "setosa",
  1: "versicolor",
  2: "virginica"
}

x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=.25)
classifier=tree.DecisionTreeClassifier()
classifier.fit(x_train,y_train)
predictions=classifier.predict(x_test)

#export the model
model_name = 'model.pkl'
print("finished training and dump the model as {0}".format(model_name))
pickle.dump(classifier, open(model_name,'wb'))
```

2. 在 Cloud Shell 執行 `train_model.py` 產生模型檔：
```bash
python train_model.py
```

3. 在 Cloud Shell 測試 `main.py`
```bash
python main.py
```

開新的 Cloud Shell 分頁，並執行 `client.py`
```bash
python client.py
```

若回傳 `setosa` 表示程式正常運作

4. build docker image & test docker image
```bash
docker build -t myiris:1.0 .
```

```
docker run -d -p 8080:8080 myiris:1.0
```

一樣在新的 Cloud Shell 分頁執行 `client.py`

若回傳 `setosa` 表示程式正常運作

5. 建立新的 repo
- Name: `test-iris`
- Region: `asia-east1 (Taiwan)`
- CREATE

6. 將 docker image build 到 repo 上<br>
build
```bash
docker build -t asia-east1-docker.pkg.dev/rare-sound-436602-v7/test-iris/myiris:1.0 .
```

push
```bash
docker push asia-east1-docker.pkg.dev/rare-sound-436602-v7/test-iris/myiris:1.0
```

7. Deploy to Cloud Run
- Service Name: `myiris`
- Region: `asia-east1 (Taiwan)`
- Authentication: `Allow unauthenticated invocations`
- CREATE

8. Test

將 `client.py` 裡的 `url` 改成 Service 的 URL
```python
url = 'https://myiris-12727410796.asia-east1.run.app'
```

執行 `client.py`
```python
python client.py
```

若回傳 `setosa` 表示成功

## Terraform

參考資料：[Day 4 — Terraform基礎 —  Terraform 簡介與安裝 - 從零開始精通DevOps與雲端技術](https://devops-with-alex.com/day-4-terraform-install/)

1. 安裝
```bash
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg && echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list && sudo apt update && sudo apt install terraform
```
