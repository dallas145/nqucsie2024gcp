# 第十二週

## 實驗
建立沒有Externl IP的VM，用Managed Load Balancer連線。

### 實作
1. 建立VPC：`myvpc1`
    - Name: `myvpc1`
    - Subnet creation mode: `Custom`
    - Firewall rules:
        - `allow-icmp`
        - `allow-ssh`

2. 建立Firewall rule
    - Name: `myvpc1-allow-healthcheck`
        - Network: `myvpc1`
        - Targets: `Specified target tags`
        - Target tags: `hc`
        - Source filter: `IPv4 ranges`
        - Source IPv4 ranges: `35.191.0.0/16`, `130.211.0.0/22` ([Google Cloud Docs](https://cloud.google.com/load-balancing/docs/health-check-concepts#ip-ranges))
        - Protocols and ports:
            - TCP: `80`

3. 建立Cloud NAT
    - Network Services -> Cloud NAT
    - Gateway name: `myvpc1-nat`
    - NAT type: `public`
    - Select Cloud Router
        - Network: `myvpc1`
        - Region: `asia-east1 (Taiwan)`
        - Cloud Router: `CREATE CLOUD ROUTER`
            - Name: `myvpc1-router`
    - Create

4. 建立Instance template
    - Name: `instance-template-1`
    - Location: `Regional`
    - Region: `asia-east1 (Taiwan)`
    - Machine configuration: `N1`
    - Boot disk:
        - Operating system: `Ubuntu`
        - Version: `Ubuntu 20.04 LTS`
    - Firewall:
        - `Allow HTTP traffic`
        - `Allow Load Balancer Healthchecks`
    - Advanced options:
        - Network tag: `hc`
        - Network interface: `myvpc1`
            - External IP address: `none`
        - Management
            - Startup script:
                ```bash
                #!/bin/bash
                apt update
                apt -y install apache2
                cat<<EOF > /var/www/html/index.html
                <html><body><p>Linux startup script added directly. $(hostname -I)</p></body></html>
                ```

5. 建立Instance group
    - New managed instance group
    - Name: `instance-group-1`
    - Instance template: `instance-template-1`
    - Location: `Singal zone`
        - Region: `asia-east1 (Taiwan)`
        - Zone: `asia-east1-b`
    - Autoscaling:
        - Autoscaling mode: `on`
        - Minimum number of instances: `1`
        - Maximum number of instances: `3`
    - Health check: `instance-group-hc`
    - CREATE

6. 建立Load Balancer
    - Type of load balancer: `Application Load Balancer (HTTP/HTTPS)`
    - Public facing of internal: `Public facing (external)`
    - Global of single region deployment: `Best for global workloads`
    - Load balancer generation: `Classic Application Load Balancer`
    - Configure:
        - Name: `my-managed-lb`
        - New Frontend IP and port
            - Name: `myfrontend`
        - Create backend service
            - Name: `mybackend`
            - instance group: `instance-group-1`
            - port number: `80`
            - Not Enable Cloud CDN
            - Create Healthcheck
                - Name: `lb-healthcheck`
        - CREATE

### 結果
![](src/linux-2024112601.png)

## Cloud Armor
免費帳號沒辦法用。

## 進階負載均衡器
用單一IP或Domain name進行多region的負載均衡


